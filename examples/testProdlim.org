* Lava some data
#+BEGIN_SRC R  :results output :exports both  :session *R* :cache no
setwd("~/research/SoftWare/prodlim/examples/")
library(lava)
library(prodlim)
## library(survival)
m <- crModel()
addvar(m) <- ~X1+X2+X3+X4+X5+X6
distribution(m,"X3") <- binomial.lvm()
distribution(m,"X4") <- normal.lvm(mean=50,sd=10)
distribution(m,"eventtime1") <- coxWeibull.lvm(scale=1/200)
distribution(m,"censtime") <- coxWeibull.lvm(scale=1/1000)
m <- categorical(m,K=4,eventtime1~X5,beta=c(1,0,0,0),p=c(0.1,0.2,0.3))
m <- categorical(m,K=3,eventtime1~X1,beta=c(2,1,0),p=c(0.3,0.2))
regression(m,to="eventtime1",from=c("X2","X4")) <- c(0.3,0)
regression(m,to="eventtime2",from=c("X2","X4")) <- c(0.6,-0.07)
set.seed(17)
d <- sim(m,200)
d$X1 <- factor(d$X1,levels=c(0,1,2),labels=c("low survival","medium survival","high survival"))
## d$X3 <- factor(d$X3,levels=c(0,1),labels=c("high survival","low survival"))
d$X5 <- factor(d$X5,levels=c("0","1","2","3"),labels=c("one","two","three","four"))
d$Event <- factor(d$event,levels=c("0","1","2"),labels=c("0","cause-1","cause-2"))
d$status <- 1*(d$event!=0)
head(d)
#+END_SRC

#+RESULTS:
#+begin_example
  eventtime1 eventtime2  censtime     time event              X1         X2 X3       X4    X5           X6   Event
1   5.548010  126.80955 55.969139 5.548010     1    low survival -0.3800461  1 58.39919 three -1.539630358 cause-1
2   3.726396   24.98956 16.025698 3.726396     1 medium survival  0.8141061  0 50.31709 three -0.107132793 cause-1
3   6.006815   71.14545  6.377146 6.006815     1 medium survival -0.2667061  0 52.26459   one -0.009700792 cause-1
4   1.967941   16.29942 43.016611 1.967941     1    low survival  1.3669155  0 52.81671  four -0.980188558 cause-1
5  10.778793   18.01080  2.823978 2.823978     0   high survival  0.3474925  1 43.89484  four -0.969826393       0
6   2.915907   18.69523 45.148577 2.915907     1 medium survival  0.3403966  1 45.89054   one  0.833379454 cause-1
  status
1      1
2      1
3      1
4      1
5      0
6      1
#+end_example

* Survival
** No covariates
*** fit + print
#+BEGIN_SRC R :exports both :results output   :session *R* 
s0 <- prodlim(Hist(time,status)~1,data=d)
print(s0)
#+END_SRC   

#+RESULTS:
#+begin_example

Call: prodlim(formula = Hist(time, status) ~ 1, data = d)

Kaplan-Meier estimator for the event time survival function

No covariates

Right-censored response of a survival model

No.Observations: 200 

Pattern:
                Freq
 event          178 
 right.censored 22
#+end_example

*** summary

#+BEGIN_SRC R :exports both :results output  :session *R*  
summary(s0,intervals=TRUE)
#+END_SRC   

#+RESULTS:
:   time0  time1 n.risk n.event n.lost  surv se.surv lower upper
: 1  0.00  0.453    200       0      0 0.995 0.00499 0.985 1.000
: 2  0.45  3.528    200      49      1 0.755 0.03046 0.695 0.814
: 3  3.53  6.496    150      47      3 0.518 0.03545 0.448 0.587
: 4  6.50 11.089    100      43      7 0.289 0.03281 0.225 0.353
: 5 11.09 25.947     50      38     11 0.000     NaN   NaN   NaN

*** predict
#+BEGIN_SRC R :exports both :results output   :session *R*  
predict(s0,times=1:10)
#+END_SRC   

#+RESULTS:
:  [1] 0.9650000 0.8750000 0.7948765 0.7143827 0.6338889 0.5379908 0.4917093 0.4082173 0.3552021 0.3115586

*** plot
#+BEGIN_SRC R :results graphics :file "s0.png" :exports both :session *R* :cache no 
plot(s0)
#+END_SRC   

#+RESULTS:
[[file:s0.png]]

** Subset
#+BEGIN_SRC R :exports both :results output   :session *R* 
su <- prodlim(Hist(time,status)~1,data=d,subset=d$X1=="medium survival")
print(su)
#+END_SRC   

#+RESULTS:
#+begin_example
null device 
          1

Call: prodlim(formula = Hist(time, status) ~ 1, data = d, subset = d$X1 == 
    "medium survival")

Kaplan-Meier estimator for the event time survival function

No covariates

Right-censored response of a survival model

No.Observations: 38 

Pattern:
                Freq
 event          37  
 right.censored 1
#+end_example

** A single binary covariate
*** fit + print
#+BEGIN_SRC R :exports both :results output   :session *R* 
s1 <- prodlim(Hist(time,status)~X1,data=d)
print(s1)
#+END_SRC   

#+RESULTS:
#+begin_example

Call: prodlim(formula = Hist(time, status) ~ X1, data = d)

Stratified Kaplan-Meier estimator for the conditional event time survival function

Discrete predictor variable: X1 (low survival, medium survival, high survival)

Right-censored response of a survival model

No.Observations: 200 

Pattern:
                Freq
 event          178 
 right.censored 22
#+end_example

*** summary

#+BEGIN_SRC R :exports both :results output  :session *R*  
summary(s1,intervals=TRUE,newdata=data.frame(X1=c("medium survival","high survival","low survival")))
#+END_SRC   

#+RESULTS:
#+begin_example
X1=low survival :
  time0  time1 n.risk n.event n.lost  surv se.surv  lower upper
1  0.00  0.453     65       0      0 1.000  0.0000 0.0000 1.000
2  0.45  3.528     65      32      0 0.508  0.0620 0.3862 0.629
3  3.53  6.496     33      25      1 0.123  0.0407 0.0432 0.203
4  6.50 11.089      7       7      0    NA      NA     NA    NA
5 11.09 25.947      0       0      0    NA      NA     NA    NA

X1=medium survival :
  time0  time1 n.risk n.event n.lost  surv se.surv lower upper
1  0.00  0.453     38       0      0 0.974  0.0260 0.923 1.000
2  0.45  3.528     38      10      0 0.737  0.0714 0.597 0.877
3  3.53  6.496     28       9      0 0.500  0.0811 0.341 0.659
4  6.50 11.089     19      12      1 0.184  0.0629 0.061 0.307
5 11.09 25.947      6       6      0    NA      NA    NA    NA

X1=high survival :
  time0  time1 n.risk n.event n.lost  surv se.surv lower upper
1  0.00  0.453     97       0      0 1.000  0.0000 0.000 1.000
2  0.45  3.528     97       7      1 0.927  0.0264 0.876 0.979
3  3.53  6.496     89      13      2 0.792  0.0415 0.710 0.873
4  6.50 11.089     74      24      6 0.525  0.0523 0.423 0.628
5 11.09 25.947     44      32     11 0.000     NaN   NaN   NaN
#+end_example

*** predict
#+BEGIN_SRC R :exports both :results output   :session *R*  
predict(s1,times=0:10,newdata=data.frame(X1=c("medium survival","low survival","high survival")))
#+END_SRC   

#+RESULTS:
: $`X1=medium survival`
:  [1] 1.0000000 0.9473684 0.8684211 0.7894737 0.6842105 0.6052632 0.5263158 0.4473684 0.3684211 0.2631579 0.2105263
: 
: $`X1=low survival`
:  [1] 1.00000000 0.92307692 0.70769231 0.55384615 0.47692308 0.33846154 0.15384615 0.10549451 0.05274725         NA
: [11]         NA
: 
: $`X1=high survival`
:  [1] 1.0000000 1.0000000 0.9896907 0.9587629 0.8858135 0.8441282 0.8023075 0.7702152 0.6619327 0.6288360 0.5604210

*** plot
#+BEGIN_SRC R :results graphics :file "s1.png" :exports both :session *R* :cache no 
plot(s1)
#+END_SRC   

#+RESULTS:
[[file:s1.png]]

** A single continuous covariate
*** fit + print
#+BEGIN_SRC R :exports both :results output   :session *R* 
s2 <- prodlim(Hist(time,status)~X2,data=d)
print(s2)
#+END_SRC   

#+RESULTS:
#+begin_example
null device 
          1

Call: prodlim(formula = Hist(time, status) ~ X2, data = d)

Stone-Beran estimator for the conditional event time survival function

Continuous predictors: X2

Right-censored response of a survival model

No.Observations: 200 

Pattern:
                Freq
 event          178 
 right.censored 22
#+end_example



*** summary

#+BEGIN_SRC R :exports both :results output  :session *R*  
summary(s2,intervals=TRUE)
#+END_SRC   

#+RESULTS:
#+begin_example
Warning in summary.prodlim(s2, intervals = TRUE) :
  
Life tables are available for 200 different covariate constellations.
 Shown are the table corresponding to the first row in object$X, corresponding to the middle row (median of the number of rows in object$X)  and corresponding to the last row in object$X ...
 to see more tables use arguments `newdata' and `max.tables'

X2=-3.401 :
  time0  time1 n.risk n.event n.lost  surv se.surv lower upper
1  0.00  0.453     31       0      0 0.968  0.0317 0.906 1.000
2  0.45  3.528     31       7      0 0.774  0.0751 0.627 0.921
3  3.53  6.496     24       7      0 0.548  0.0894 0.373 0.724
4  6.50 11.089     17       6      2 0.347  0.0867 0.178 0.517
5 11.09 25.947      9       7      2    NA      NA    NA    NA

X2= 0.022 :
  time0  time1 n.risk n.event n.lost  surv se.surv lower upper
1  0.00  0.453     61       0      0 1.000  0.0000 0.000 1.000
2  0.45  3.528     61      16      1 0.736  0.0567 0.625 0.847
3  3.53  6.496     44      13      2 0.518  0.0646 0.391 0.644
4  6.50 11.089     29      14      2 0.266  0.0587 0.151 0.381
5 11.09 25.947     13      10      3    NA      NA    NA    NA

X2= 3.092 :
  time0  time1 n.risk n.event n.lost  surv se.surv  lower upper
1  0.00  0.453     31       0      0 1.000  0.0000 0.0000 1.000
2  0.45  3.528     31      12      0 0.613  0.0875 0.4414 0.784
3  3.53  6.496     19       6      0 0.419  0.0886 0.2456 0.593
4  6.50 11.089     13       7      1 0.179  0.0709 0.0402 0.318
5 11.09 25.947      5       5      0    NA      NA     NA    NA
#+end_example

*** predict
#+BEGIN_SRC R :exports both :results output   :session *R*  
predict(s2,times=0:10,newdata=data.frame(X2=quantile(d$X2)))
#+END_SRC   

#+RESULTS:
#+begin_example
$`X2=-3.401`
 [1] 1.0000000 0.9677419 0.9354839 0.8064516 0.7419355 0.6129032 0.5806452 0.5483871 0.4168734 0.3473945 0.3473945

$`X2=-0.508`
 [1] 1.0000000 0.9672131 0.9508197 0.8524590 0.7377049 0.6393443 0.5737705 0.5081967 0.4426230 0.3442623 0.3098361

$`X2= 0.024`
 [1] 1.0000000 0.9672131 0.8852459 0.8026230 0.6855738 0.6019672 0.5350820 0.4999654 0.3928299 0.3571181 0.3035504

$`X2= 0.708`
 [1] 1.0000000 0.9672131 0.8524590 0.8193443 0.7524590 0.6855738 0.5685246 0.4996125 0.4134724 0.3790164 0.3068228

$`X2= 3.092`
 [1] 1.0000000 0.9677419 0.7096774 0.6451613 0.6129032 0.5806452 0.4193548 0.3548387 0.2867384 0.2508961 0.1792115
#+end_example

*** plot

#+BEGIN_SRC R :results graphics :file "s2.png" :exports both :session *R* :cache no 
plot(s2)
#+END_SRC   

#+RESULTS:
[[file:s2.png]]


** Combination of two categorical covariates
*** fit + print
#+BEGIN_SRC R :exports both :results output   :session *R* 
s1a <- prodlim(Hist(time,status)~X1+X3,data=d)
print(s1a)
#+END_SRC   

#+RESULTS:
#+begin_example
null device 
          1

Call: prodlim(formula = Hist(time, status) ~ X1 + X3, data = d)

Stratified Kaplan-Meier estimator for the conditional event time survival function

Discrete predictor variables:

 -  X1 (low survival, medium survival, high survival)
 -  X3 (1, 0)

Right-censored response of a survival model

No.Observations: 200 

Pattern:
                Freq
 event          178 
 right.censored 22
#+end_example

*** summary

#+BEGIN_SRC R :exports both :results output  :session *R*  
summary(s1a,intervals=TRUE)
#+END_SRC   

#+RESULTS:
#+begin_example
X1=low survival, X3=0 :
  time0  time1 n.risk n.event n.lost  surv se.surv  lower upper
1  0.00  0.453     33       0      0 1.000  0.0000 0.0000 1.000
2  0.45  3.528     33      16      0 0.515  0.0870 0.3446 0.686
3  3.53  6.496     17      11      0 0.182  0.0671 0.0502 0.313
4  6.50 11.089      6       6      0    NA      NA     NA    NA
5 11.09 25.947      0       0      0    NA      NA     NA    NA

X1=medium survival, X3=0 :
  time0  time1 n.risk n.event n.lost  surv se.surv lower upper
1  0.00  0.453     19       0      0 1.000  0.0000 0.000 1.000
2  0.45  3.528     19       4      0 0.789  0.0935 0.606 0.973
3  3.53  6.496     15       6      0 0.474  0.1145 0.249 0.698
4  6.50 11.089      9       3      1 0.316  0.1066 0.107 0.525
5 11.09 25.947      5       5      0    NA      NA    NA    NA

X1=high survival, X3=0 :
  time0  time1 n.risk n.event n.lost  surv se.surv lower upper
1  0.00  0.453     49       0      0 1.000  0.0000 0.000 1.000
2  0.45  3.528     49       4      0 0.918  0.0391 0.842 0.995
3  3.53  6.496     45       4      1 0.836  0.0530 0.732 0.940
4  6.50 11.089     40      15      2 0.519  0.0725 0.377 0.661
5 11.09 25.947     23      17      6    NA      NA    NA    NA

X1=low survival, X3=1 :
  time0  time1 n.risk n.event n.lost   surv se.surv lower upper
1  0.00  0.453     32       0      0 1.0000  0.0000 0.000 1.000
2  0.45  3.528     32      16      0 0.5000  0.0884 0.327 0.673
3  3.53  6.496     16      14      1 0.0625  0.0428 0.000 0.146
4  6.50 11.089      1       1      0     NA      NA    NA    NA
5 11.09 25.947      0       0      0     NA      NA    NA    NA

X1=medium survival, X3=1 :
  time0  time1 n.risk n.event n.lost   surv se.surv lower upper
1  0.00  0.453     19       0      0 0.9474  0.0512 0.847 1.000
2  0.45  3.528     19       6      0 0.6842  0.1066 0.475 0.893
3  3.53  6.496     13       3      0 0.5263  0.1145 0.302 0.751
4  6.50 11.089     10       9      0 0.0526  0.0512 0.000 0.153
5 11.09 25.947      1       1      0     NA      NA    NA    NA

X1=high survival, X3=1 :
  time0  time1 n.risk n.event n.lost  surv se.surv lower upper
1  0.00  0.453     48       0      0 1.000  0.0000 0.000 1.000
2  0.45  3.528     48       3      1 0.937  0.0352 0.868 1.000
3  3.53  6.496     44       9      1 0.745  0.0635 0.621 0.870
4  6.50 11.089     34       9      4 0.536  0.0751 0.389 0.683
5 11.09 25.947     21      15      5 0.000     NaN   NaN   NaN
#+end_example

*** predict
#+BEGIN_SRC R :exports both :results output   :session *R*  
predict(s1a,times=0:10,newdata=expand.grid(X1=levels(d$X1),X3=unique(d$X3)))
#+END_SRC   

#+RESULTS:
#+begin_example
$`X1=low survival, X3=1`
 [1] 1.00000 0.90625 0.71875 0.59375 0.50000 0.28125 0.06250 0.06250      NA      NA      NA

$`X1=medium survival, X3=1`
 [1] 1.00000000 0.94736842 0.89473684 0.73684211 0.63157895 0.57894737 0.52631579 0.42105263 0.26315789 0.15789474
[11] 0.05263158

$`X1=high survival, X3=1`
 [1] 1.0000000 1.0000000 0.9791667 0.9583333 0.8731481 0.8092593 0.7453704 0.7234477 0.6334865 0.6100241 0.5612221

$`X1=low survival, X3=0`
 [1] 1.00000000 0.93939394 0.69696970 0.51515152 0.45454545 0.39393939 0.24242424 0.15151515 0.09090909         NA
[11]         NA

$`X1=medium survival, X3=0`
 [1] 1.0000000 0.9473684 0.8421053 0.8421053 0.7368421 0.6315789 0.5263158 0.4736842 0.4736842 0.3684211 0.3684211

$`X1=high survival, X3=0`
 [1] 1.0000000 1.0000000 1.0000000 0.9591837 0.8979592 0.8775510 0.8571429 0.8153310 0.6898955 0.6480836 0.5622972
#+end_example

*** plot
#+BEGIN_SRC R :results graphics :file "s1a.png" :exports both :session *R* :cache no
## par(mar=c(3,3,3,3))
plot(s1a,confint=FALSE,atrisk=FALSE,legend.x="bottomleft",legend.cex=0.8)
#+END_SRC   

#+RESULTS:
[[file:s1a.png]]

** Combination of one categorical and one continuous covariate
*** fit + print
#+BEGIN_SRC R :exports both :results output   :session *R* 
s3 <- prodlim(Hist(time,status)~X1+X2,data=d)
print(s3)
#+END_SRC   

#+RESULTS:
#+begin_example
null device 
          1

Call: prodlim(formula = Hist(time, status) ~ X1 + X2, data = d)

Stratified Stone-Beran estimator for the conditional event time survival function

  Discrete predictor variables: X1
Continuous predictor variables: X2

Right-censored response of a survival model

No.Observations: 200 

Pattern:
                Freq
 event          178 
 right.censored 22
#+end_example

*** summary

#+BEGIN_SRC R :exports both :results output  :session *R*  
summary(s3,intervals=TRUE)
#+END_SRC   

#+RESULTS:
#+begin_example
Warning in summary.prodlim(s3, intervals = TRUE) :
  
Life tables are available for 200 different covariate constellations.
 Shown are the table corresponding to the first row in object$X, corresponding to the middle row (median of the number of rows in object$X)  and corresponding to the last row in object$X ...
 to see more tables use arguments `newdata' and `max.tables'

X1=low survival, X2=-3.4 :
  time0  time1 n.risk n.event n.lost  surv se.surv lower upper
1  0.00  0.453     15       0      0 1.000   0.000 0.000 1.000
2  0.45  3.528     15       5      0 0.667   0.122 0.428 0.905
3  3.53  6.496     10       7      0 0.200   0.103 0.000 0.402
4  6.50 11.089      3       3      0    NA      NA    NA    NA
5 11.09 25.947      0       0      0    NA      NA    NA    NA

X1=medium survival, X2= 1.1 :
  time0  time1 n.risk n.event n.lost   surv se.surv lower upper
1  0.00  0.453     14       0      0 1.0000  0.0000 0.000 1.000
2  0.45  3.528     14       4      0 0.7143  0.1207 0.478 0.951
3  3.53  6.496     10       4      0 0.4286  0.1323 0.169 0.688
4  6.50 11.089      6       5      0 0.0714  0.0688 0.000 0.206
5 11.09 25.947      1       1      0     NA      NA    NA    NA

X1=high survival, X2= 3.1 :
  time0  time1 n.risk n.event n.lost  surv se.surv lower upper
1  0.00  0.453     20       0      0 1.000  0.0000 0.000 1.000
2  0.45  3.528     20       0      0 1.000  0.0000 0.000 1.000
3  3.53  6.496     20       4      0 0.800  0.0894 0.625 0.975
4  6.50 11.089     16       6      1 0.487  0.1140 0.264 0.711
5 11.09 25.947      9       9      0    NA      NA    NA    NA
#+end_example

*** predict
#+BEGIN_SRC R :exports both :results output   :session *R*  
predict(s3,times=0:10,newdata=expand.grid(X1=levels(d$X1),X2=c(quantile(d$X2,0.05),median(d$X2))))
#+END_SRC   

#+RESULTS:
#+begin_example
$`X1=low survival, X2=-1.543`
 [1] 1.0000000 1.0000000 0.9473684 0.6842105 0.6315789 0.4736842 0.3157895 0.2105263 0.1052632        NA        NA

$`X1=medium survival, X2=-1.543`
 [1] 1.0000000 0.9230769 0.9230769 0.8461538 0.6923077 0.6153846 0.6153846 0.5384615 0.4615385 0.2307692 0.2307692

$`X1=high survival, X2=-1.543`
 [1] 1.0000000 1.0000000 1.0000000 1.0000000 0.8636364 0.8181818 0.8181818 0.8181818 0.7244318 0.7244318 0.6278409

$`X1=low survival, X2= 0.024`
 [1] 1.00000000 0.86206897 0.68965517 0.58620690 0.44827586 0.24137931 0.06896552 0.03448276         NA         NA
[11]         NA

$`X1=medium survival, X2= 0.024`
 [1] 1.0000000 0.9523810 0.8571429 0.8095238 0.7142857 0.6666667 0.5714286 0.4761905 0.4285714 0.2857143 0.2380952

$`X1=high survival, X2= 0.024`
 [1] 1.0000000 1.0000000 0.9743590 0.8974359 0.8182504 0.7918552 0.7654600 0.7654600 0.6237082 0.5670074 0.4739691
#+end_example

*** plot
#+BEGIN_SRC R :results graphics :file "s3.png" :exports both :session *R* :cache no 
plot(s3,confint=FALSE,atrisk=FALSE,legend.x="bottomleft",legend.cex=0.8,newdata=expand.grid(X1=levels(d$X1),X2=c(quantile(d$X2,0.05),median(d$X2))))
#+END_SRC   

#+RESULTS:
[[file:s3.png]]

* Competing risks
** No covariates
*** fit + print
#+BEGIN_SRC R :exports both :results output   :session *R* 
f0 <- prodlim(Hist(time,event)~1,data=d)
print(f0)
#+END_SRC   

#+RESULTS:
#+begin_example
null device 
          1

Call: prodlim(formula = Hist(time, event) ~ 1, data = d)


No covariates

Right-censored response of a competing.risks model

No.Observations: 200 

Pattern:
         
Cause     event right.censored
  1         175              0
  2           3              0
  unknown     0             22
#+end_example

*** summary

#+BEGIN_SRC R :exports both :results output  :session *R*  
summary(f0,intervals=TRUE)
#+END_SRC   

#+RESULTS:
#+begin_example


----------> Cause:  1 

  time0  time1 n.risk n.event n.lost cuminc se.cuminc lower  upper
1  0.00  0.453    200       0      0  0.005   0.00499 0.000 0.0148
2  0.45  3.528    200      49      1  0.245   0.03046 0.186 0.3051
3  3.53  6.496    150      45      3  0.472   0.03542 0.403 0.5418
4  6.50 11.089    100      43      7  0.701   0.03312 0.636 0.7657
5 11.09 25.947     50      37     11  0.984       NaN   NaN    NaN


----------> Cause:  2 

  time0  time1 n.risk n.event n.lost cuminc se.cuminc lower  upper
1  0.00  0.453    200       0      0 0.0000   0.00000     0 0.0000
2  0.45  3.528    200       0      1 0.0000   0.00000     0 0.0000
3  3.53  6.496    150       2      3 0.0101   0.00708     0 0.0239
4  6.50 11.089    100       0      7 0.0101   0.00708     0 0.0239
5 11.09 25.947     50       1     11 0.0163       NaN   NaN    NaN
#+end_example

*** predict
#+BEGIN_SRC R :exports both :results output   :session *R*  
predict(f0,times=1:10)
#+END_SRC   

#+RESULTS:
:  [1] 0.0350000 0.1250000 0.2051235 0.2805864 0.3560494 0.4519474 0.4982289 0.5817210 0.6347362 0.6783796

*** plot
#+BEGIN_SRC R :results graphics :file "f0.png" :exports both :session *R* :cache no 
plot(f0)
#+END_SRC   

#+RESULTS:
[[file:f0.png]]

** A single binary covariate
*** fit + print
#+BEGIN_SRC R :exports both :results output   :session *R* 
f1 <- prodlim(Hist(time,event)~X1,data=d)
print(f1)
#+END_SRC   

#+RESULTS:
#+begin_example
null device 
          1

Call: prodlim(formula = Hist(time, event) ~ X1, data = d)


Discrete predictor variable: X1 (low survival, medium survival, high survival)

Right-censored response of a competing.risks model

No.Observations: 200 

Pattern:
         
Cause     event right.censored
  1         175              0
  2           3              0
  unknown     0             22
#+end_example

*** summary

#+BEGIN_SRC R :exports both :results output  :session *R*  
summary(f1,intervals=TRUE,newdata=data.frame(X1=c("medium survival","high survival","low survival")))
#+END_SRC   

#+RESULTS:
#+begin_example


----------> Cause:  1 

X1=low survival :
  time0  time1 n.risk n.event n.lost cuminc se.cuminc lower upper
1  0.00  0.453     65       0      0  0.000    0.0000 0.000 0.000
2  0.45  3.528     65      32      0  0.492    0.0620 0.371 0.614
3  3.53  6.496     33      25      1  0.877    0.0407 0.797 0.957
4  6.50 11.089      7       7      0     NA        NA    NA    NA
5 11.09 25.947      0       0      0     NA        NA    NA    NA

X1=medium survival :
  time0  time1 n.risk n.event n.lost cuminc se.cuminc lower  upper
1  0.00  0.453     38       0      0 0.0263    0.0260 0.000 0.0772
2  0.45  3.528     38      10      0 0.2632    0.0714 0.123 0.4032
3  3.53  6.496     28       9      0 0.5000    0.0811 0.341 0.6590
4  6.50 11.089     19      12      1 0.8158    0.0629 0.693 0.9390
5 11.09 25.947      6       6      0     NA        NA    NA     NA

X1=high survival :
  time0  time1 n.risk n.event n.lost cuminc se.cuminc  lower upper
1  0.00  0.453     97       0      0 0.0000    0.0000 0.0000 0.000
2  0.45  3.528     97       7      1 0.0725    0.0264 0.0208 0.124
3  3.53  6.496     89      11      2 0.1875    0.0399 0.1094 0.266
4  6.50 11.089     74      24      6 0.4538    0.0521 0.3516 0.556
5 11.09 25.947     44      31     11 0.9663       NaN    NaN   NaN



----------> Cause:  2 

X1=low survival :
  time0  time1 n.risk n.event n.lost cuminc se.cuminc lower upper
1  0.00  0.453     65       0      0      0         0     0     0
2  0.45  3.528     65       0      0      0         0     0     0
3  3.53  6.496     33       0      1      0         0     0     0
4  6.50 11.089      7       0      0     NA        NA    NA    NA
5 11.09 25.947      0       0      0     NA        NA    NA    NA

X1=medium survival :
  time0  time1 n.risk n.event n.lost cuminc se.cuminc lower upper
1  0.00  0.453     38       0      0      0         0     0     0
2  0.45  3.528     38       0      0      0         0     0     0
3  3.53  6.496     28       0      0      0         0     0     0
4  6.50 11.089     19       0      1      0         0     0     0
5 11.09 25.947      6       0      0     NA        NA    NA    NA

X1=high survival :
  time0  time1 n.risk n.event n.lost cuminc se.cuminc lower  upper
1  0.00  0.453     97       0      0 0.0000    0.0000     0 0.0000
2  0.45  3.528     97       0      1 0.0000    0.0000     0 0.0000
3  3.53  6.496     89       2      2 0.0208    0.0146     0 0.0494
4  6.50 11.089     74       0      6 0.0208    0.0146     0 0.0494
5 11.09 25.947     44       1     11 0.0337       NaN   NaN    NaN
#+end_example

*** predict
#+BEGIN_SRC R :exports both :results output   :session *R*  
predict(f1,times=0:10,newdata=data.frame(X1=c("medium survival","low survival","high survival")))
#+END_SRC   

#+RESULTS:
#+begin_example
$`X1=medium survival`
 [1] 0.00000000 0.05263158 0.13157895 0.21052632 0.31578947 0.39473684 0.47368421 0.55263158 0.63157895 0.73684211
[11] 0.78947368

$`X1=low survival`
 [1] 0.00000000 0.07692308 0.29230769 0.44615385 0.52307692 0.66153846 0.84615385 0.89450549 0.94725275         NA
[11]         NA

$`X1=high survival`
 [1] 0.00000000 0.00000000 0.01030928 0.04123711 0.10376513 0.13502913 0.17684982 0.20894212 0.31722466 0.35032130
[11] 0.41873633
#+end_example

*** plot
#+BEGIN_SRC R :results graphics :file "f1.png" :exports both :session *R* :cache no 
plot(f1)
#+END_SRC   

#+RESULTS:
[[file:f1.png]]

** A single continuous covariate
*** fit + print
#+BEGIN_SRC R :exports both :results output   :session *R* 
f2 <- prodlim(Hist(time,event)~X2,data=d)
print(f2)
#+END_SRC   

#+RESULTS:
#+begin_example
null device 
          1

Call: prodlim(formula = Hist(time, event) ~ X2, data = d)


Continuous predictors: X2

Right-censored response of a competing.risks model

No.Observations: 200 

Pattern:
         
Cause     event right.censored
  1         175              0
  2           3              0
  unknown     0             22
#+end_example

*** summary

#+BEGIN_SRC R :exports both :results output  :session *R*  
summary(f2,intervals=TRUE)
#+END_SRC   

#+RESULTS:
#+begin_example
Warning in summary.prodlim(f2, intervals = TRUE) :
  
Life tables are available for 200 different covariate constellations.
 Shown are the table corresponding to the first row in object$X, corresponding to the middle row (median of the number of rows in object$X)  and corresponding to the last row in object$X ...
 to see more tables use arguments `newdata' and `max.tables'



----------> Cause:  1 

X2=-3.401 :
  time0  time1 n.risk n.event n.lost cuminc se.cuminc  lower  upper
1  0.00  0.453     31       0      0 0.0323    0.0317 0.0000 0.0945
2  0.45  3.528     31       7      0 0.2258    0.0751 0.0786 0.3730
3  3.53  6.496     24       7      0 0.4516    0.0894 0.2764 0.6268
4  6.50 11.089     17       6      2 0.6526    0.0867 0.4827 0.8225
5 11.09 25.947      9       6      2     NA        NA     NA     NA

X2= 0.022 :
  time0  time1 n.risk n.event n.lost cuminc se.cuminc lower upper
1  0.00  0.453     61       0      0  0.000    0.0000 0.000 0.000
2  0.45  3.528     61      16      1  0.264    0.0567 0.153 0.375
3  3.53  6.496     44      12      2  0.465    0.0644 0.339 0.592
4  6.50 11.089     29      14      2  0.718    0.0597 0.601 0.835
5 11.09 25.947     13      10      3     NA        NA    NA    NA

X2= 3.092 :
  time0  time1 n.risk n.event n.lost cuminc se.cuminc lower upper
1  0.00  0.453     31       0      0  0.000    0.0000 0.000 0.000
2  0.45  3.528     31      12      0  0.387    0.0875 0.216 0.559
3  3.53  6.496     19       6      0  0.581    0.0886 0.407 0.754
4  6.50 11.089     13       7      1  0.821    0.0709 0.682 0.960
5 11.09 25.947      5       5      0     NA        NA    NA    NA



----------> Cause:  2 

X2=-3.401 :
  time0  time1 n.risk n.event n.lost cuminc se.cuminc lower upper
1  0.00  0.453     31       0      0      0         0     0     0
2  0.45  3.528     31       0      0      0         0     0     0
3  3.53  6.496     24       0      0      0         0     0     0
4  6.50 11.089     17       0      2      0         0     0     0
5 11.09 25.947      9       1      2     NA        NA    NA    NA

X2= 0.022 :
  time0  time1 n.risk n.event n.lost cuminc se.cuminc lower  upper
1  0.00  0.453     61       0      0 0.0000    0.0000     0 0.0000
2  0.45  3.528     61       0      1 0.0000    0.0000     0 0.0000
3  3.53  6.496     44       1      2 0.0167    0.0166     0 0.0492
4  6.50 11.089     29       0      2 0.0167    0.0166     0 0.0492
5 11.09 25.947     13       0      3     NA        NA    NA     NA

X2= 3.092 :
  time0  time1 n.risk n.event n.lost cuminc se.cuminc lower upper
1  0.00  0.453     31       0      0      0         0     0     0
2  0.45  3.528     31       0      0      0         0     0     0
3  3.53  6.496     19       0      0      0         0     0     0
4  6.50 11.089     13       0      1      0         0     0     0
5 11.09 25.947      5       0      0     NA        NA    NA    NA
#+end_example

*** predict
#+BEGIN_SRC R :exports both :results output   :session *R*  
predict(f2,times=0:10,newdata=data.frame(X2=quantile(d$X2)))
#+END_SRC   

#+RESULTS:
#+begin_example
$`X2=-3.401`
 [1] 0.00000000 0.03225806 0.06451613 0.19354839 0.25806452 0.38709677 0.41935484 0.45161290 0.58312655 0.65260546
[11] 0.65260546

$`X2=-0.508`
 [1] 0.00000000 0.03278689 0.04918033 0.14754098 0.26229508 0.36065574 0.42622951 0.49180328 0.55737705 0.65573770
[11] 0.69016393

$`X2= 0.024`
 [1] 0.00000000 0.03278689 0.11475410 0.19737705 0.29770492 0.38131148 0.44819672 0.48331334 0.59044877 0.62616058
[11] 0.67972830

$`X2= 0.708`
 [1] 0.00000000 0.03278689 0.14754098 0.18065574 0.23081967 0.28098361 0.39803279 0.46694486 0.55308495 0.58754098
[11] 0.65973458

$`X2= 3.092`
 [1] 0.00000000 0.03225806 0.29032258 0.35483871 0.38709677 0.41935484 0.58064516 0.64516129 0.71326165 0.74910394
[11] 0.82078853
#+end_example

*** plot
#+BEGIN_SRC R :results graphics :file "f2.png" :exports both :session *R* :cache no 
plot(f2)
## plot(0,0)
#+END_SRC   

#+RESULTS:
[[file:f2.png]]

** Combination of two categorical covariates
*** fit + print
#+BEGIN_SRC R :exports both :results output   :session *R* 
f1a <- prodlim(Hist(time,event)~X1+X3,data=d)
print(f1a)
#+END_SRC   

#+RESULTS:
#+begin_example
null device 
          1

Call: prodlim(formula = Hist(time, event) ~ X1 + X3, data = d)


Discrete predictor variables:

 -  X1 (low survival, medium survival, high survival)
 -  X3 (1, 0)

Right-censored response of a competing.risks model

No.Observations: 200 

Pattern:
         
Cause     event right.censored
  1         175              0
  2           3              0
  unknown     0             22
#+end_example

*** summary

#+BEGIN_SRC R :exports both :results output  :session *R*  
summary(f1a,intervals=TRUE)
#+END_SRC   

#+RESULTS:
#+begin_example


----------> Cause:  1 

X1=low survival, X3=0 :
  time0  time1 n.risk n.event n.lost cuminc se.cuminc lower upper
1  0.00  0.453     33       0      0  0.000    0.0000 0.000 0.000
2  0.45  3.528     33      16      0  0.485    0.0870 0.314 0.655
3  3.53  6.496     17      11      0  0.818    0.0671 0.687 0.950
4  6.50 11.089      6       6      0     NA        NA    NA    NA
5 11.09 25.947      0       0      0     NA        NA    NA    NA

X1=medium survival, X3=0 :
  time0  time1 n.risk n.event n.lost cuminc se.cuminc  lower upper
1  0.00  0.453     19       0      0  0.000    0.0000 0.0000 0.000
2  0.45  3.528     19       4      0  0.211    0.0935 0.0272 0.394
3  3.53  6.496     15       6      0  0.526    0.1145 0.3018 0.751
4  6.50 11.089      9       3      1  0.684    0.1066 0.4752 0.893
5 11.09 25.947      5       5      0     NA        NA     NA    NA

X1=high survival, X3=0 :
  time0  time1 n.risk n.event n.lost cuminc se.cuminc   lower upper
1  0.00  0.453     49       0      0 0.0000    0.0000 0.00000 0.000
2  0.45  3.528     49       4      0 0.0816    0.0391 0.00497 0.158
3  3.53  6.496     45       3      1 0.1434    0.0502 0.04504 0.242
4  6.50 11.089     40      15      2 0.4605    0.0724 0.31872 0.602
5 11.09 25.947     23      16      6     NA        NA      NA    NA

X1=low survival, X3=1 :
  time0  time1 n.risk n.event n.lost cuminc se.cuminc lower upper
1  0.00  0.453     32       0      0  0.000    0.0000 0.000 0.000
2  0.45  3.528     32      16      0  0.500    0.0884 0.327 0.673
3  3.53  6.496     16      14      1  0.938    0.0428 0.854 1.000
4  6.50 11.089      1       1      0     NA        NA    NA    NA
5 11.09 25.947      0       0      0     NA        NA    NA    NA

X1=medium survival, X3=1 :
  time0  time1 n.risk n.event n.lost cuminc se.cuminc lower upper
1  0.00  0.453     19       0      0 0.0526    0.0512 0.000 0.153
2  0.45  3.528     19       6      0 0.3158    0.1066 0.107 0.525
3  3.53  6.496     13       3      0 0.4737    0.1145 0.249 0.698
4  6.50 11.089     10       9      0 0.9474    0.0512 0.847 1.000
5 11.09 25.947      1       1      0     NA        NA    NA    NA

X1=high survival, X3=1 :
  time0  time1 n.risk n.event n.lost cuminc se.cuminc lower upper
1  0.00  0.453     48       0      0  0.000    0.0000 0.000 0.000
2  0.45  3.528     48       3      1  0.063    0.0352 0.000 0.132
3  3.53  6.496     44       8      1  0.233    0.0616 0.113 0.354
4  6.50 11.089     34       9      4  0.443    0.0748 0.296 0.590
5 11.09 25.947     21      15      5  0.979       NaN   NaN   NaN



----------> Cause:  2 

X1=low survival, X3=0 :
  time0  time1 n.risk n.event n.lost cuminc se.cuminc lower upper
1  0.00  0.453     33       0      0      0         0     0     0
2  0.45  3.528     33       0      0      0         0     0     0
3  3.53  6.496     17       0      0      0         0     0     0
4  6.50 11.089      6       0      0     NA        NA    NA    NA
5 11.09 25.947      0       0      0     NA        NA    NA    NA

X1=medium survival, X3=0 :
  time0  time1 n.risk n.event n.lost cuminc se.cuminc lower upper
1  0.00  0.453     19       0      0      0         0     0     0
2  0.45  3.528     19       0      0      0         0     0     0
3  3.53  6.496     15       0      0      0         0     0     0
4  6.50 11.089      9       0      1      0         0     0     0
5 11.09 25.947      5       0      0     NA        NA    NA    NA

X1=high survival, X3=0 :
  time0  time1 n.risk n.event n.lost cuminc se.cuminc lower upper
1  0.00  0.453     49       0      0 0.0000    0.0000     0  0.00
2  0.45  3.528     49       0      0 0.0000    0.0000     0  0.00
3  3.53  6.496     45       1      1 0.0204    0.0202     0  0.06
4  6.50 11.089     40       0      2 0.0204    0.0202     0  0.06
5 11.09 25.947     23       1      6     NA        NA    NA    NA

X1=low survival, X3=1 :
  time0  time1 n.risk n.event n.lost cuminc se.cuminc lower upper
1  0.00  0.453     32       0      0      0         0     0     0
2  0.45  3.528     32       0      0      0         0     0     0
3  3.53  6.496     16       0      1      0         0     0     0
4  6.50 11.089      1       0      0     NA        NA    NA    NA
5 11.09 25.947      0       0      0     NA        NA    NA    NA

X1=medium survival, X3=1 :
  time0  time1 n.risk n.event n.lost cuminc se.cuminc lower upper
1  0.00  0.453     19       0      0      0         0     0     0
2  0.45  3.528     19       0      0      0         0     0     0
3  3.53  6.496     13       0      0      0         0     0     0
4  6.50 11.089     10       0      0      0         0     0     0
5 11.09 25.947      1       0      0     NA        NA    NA    NA

X1=high survival, X3=1 :
  time0  time1 n.risk n.event n.lost cuminc se.cuminc lower  upper
1  0.00  0.453     48       0      0 0.0000    0.0000     0 0.0000
2  0.45  3.528     48       0      1 0.0000    0.0000     0 0.0000
3  3.53  6.496     44       1      1 0.0213    0.0211     0 0.0626
4  6.50 11.089     34       0      4 0.0213    0.0211     0 0.0626
5 11.09 25.947     21       0      5 0.0213       NaN   NaN    NaN
#+end_example

*** predict
#+BEGIN_SRC R :exports both :results output   :session *R*  
predict(f1a,times=0:10,newdata=expand.grid(X1=levels(d$X1),X3=unique(d$X3)))
#+END_SRC   

#+RESULTS:
#+begin_example
$`X1=low survival, X3=1`
 [1] 0.00000 0.09375 0.28125 0.40625 0.50000 0.71875 0.93750 0.93750      NA      NA      NA

$`X1=medium survival, X3=1`
 [1] 0.00000000 0.05263158 0.10526316 0.26315789 0.36842105 0.42105263 0.47368421 0.57894737 0.73684211 0.84210526
[11] 0.94736842

$`X1=high survival, X3=1`
 [1] 0.00000000 0.00000000 0.02083333 0.04166667 0.12685185 0.16944444 0.23333333 0.25525599 0.34521718 0.36867965
[11] 0.41748157

$`X1=low survival, X3=0`
 [1] 0.00000000 0.06060606 0.30303030 0.48484848 0.54545455 0.60606061 0.75757576 0.84848485 0.90909091         NA
[11]         NA

$`X1=medium survival, X3=0`
 [1] 0.00000000 0.05263158 0.15789474 0.15789474 0.26315789 0.36842105 0.47368421 0.52631579 0.52631579 0.63157895
[11] 0.63157895

$`X1=high survival, X3=0`
 [1] 0.00000000 0.00000000 0.00000000 0.04081633 0.08163265 0.10204082 0.12244898 0.16426083 0.28969637 0.33150821
[11] 0.41729459
#+end_example

*** plot
#+BEGIN_SRC R :results graphics :file "f1a.png" :exports both :session *R* :cache no 
plot(f1a,confint=FALSE,atrisk=FALSE,legend.x="bottomleft",legend.cex=0.8)
#+END_SRC   

#+RESULTS:
[[file:f1a.png]]

** Combination of one categorical and one continuous covariate
*** fit + print
#+BEGIN_SRC R :exports both :results output   :session *R* 
f3 <- prodlim(Hist(time,event)~X1+X2,data=d)
print(f3)
#+END_SRC   

#+RESULTS:
#+begin_example
null device 
          1

Call: prodlim(formula = Hist(time, event) ~ X1 + X2, data = d)


  Discrete predictor variables: X1
Continuous predictor variables: X2

Right-censored response of a competing.risks model

No.Observations: 200 

Pattern:
         
Cause     event right.censored
  1         175              0
  2           3              0
  unknown     0             22
#+end_example

*** summary

#+BEGIN_SRC R :exports both :results output  :session *R*  
summary(f3,intervals=TRUE)
#+END_SRC   

#+RESULTS:
#+begin_example
Warning in summary.prodlim(f3, intervals = TRUE) :
  
Life tables are available for 200 different covariate constellations.
 Shown are the table corresponding to the first row in object$X, corresponding to the middle row (median of the number of rows in object$X)  and corresponding to the last row in object$X ...
 to see more tables use arguments `newdata' and `max.tables'



----------> Cause:  1 

X1=low survival, X2=-3.4 :
  time0  time1 n.risk n.event n.lost cuminc se.cuminc  lower upper
1  0.00  0.453     15       0      0  0.000     0.000 0.0000 0.000
2  0.45  3.528     15       5      0  0.333     0.122 0.0948 0.572
3  3.53  6.496     10       7      0  0.800     0.103 0.5976 1.000
4  6.50 11.089      3       3      0     NA        NA     NA    NA
5 11.09 25.947      0       0      0     NA        NA     NA    NA

X1=medium survival, X2= 1.1 :
  time0  time1 n.risk n.event n.lost cuminc se.cuminc  lower upper
1  0.00  0.453     14       0      0  0.000    0.0000 0.0000 0.000
2  0.45  3.528     14       4      0  0.286    0.1207 0.0491 0.522
3  3.53  6.496     10       4      0  0.571    0.1323 0.3122 0.831
4  6.50 11.089      6       5      0  0.929    0.0688 0.7937 1.000
5 11.09 25.947      1       1      0     NA        NA     NA    NA

X1=high survival, X2= 3.1 :
  time0  time1 n.risk n.event n.lost cuminc se.cuminc  lower upper
1  0.00  0.453     20       0      0  0.000    0.0000 0.0000 0.000
2  0.45  3.528     20       0      0  0.000    0.0000 0.0000 0.000
3  3.53  6.496     20       4      0  0.200    0.0894 0.0247 0.375
4  6.50 11.089     16       6      1  0.512    0.1140 0.2890 0.736
5 11.09 25.947      9       9      0     NA        NA     NA    NA



----------> Cause:  2 

X1=low survival, X2=-3.4 :
  time0  time1 n.risk n.event n.lost cuminc se.cuminc lower upper
1  0.00  0.453     15       0      0      0         0     0     0
2  0.45  3.528     15       0      0      0         0     0     0
3  3.53  6.496     10       0      0      0         0     0     0
4  6.50 11.089      3       0      0     NA        NA    NA    NA
5 11.09 25.947      0       0      0     NA        NA    NA    NA

X1=medium survival, X2= 1.1 :
  time0  time1 n.risk n.event n.lost cuminc se.cuminc lower upper
1  0.00  0.453     14       0      0      0         0     0     0
2  0.45  3.528     14       0      0      0         0     0     0
3  3.53  6.496     10       0      0      0         0     0     0
4  6.50 11.089      6       0      0      0         0     0     0
5 11.09 25.947      1       0      0     NA        NA    NA    NA

X1=high survival, X2= 3.1 :
  time0  time1 n.risk n.event n.lost cuminc se.cuminc lower upper
1  0.00  0.453     20       0      0      0         0     0     0
2  0.45  3.528     20       0      0      0         0     0     0
3  3.53  6.496     20       0      0      0         0     0     0
4  6.50 11.089     16       0      1      0         0     0     0
5 11.09 25.947      9       0      0     NA        NA    NA    NA
#+end_example

*** predict
#+BEGIN_SRC R :exports both :results output   :session *R*  
predict(f3,times=0:10,newdata=expand.grid(X1=levels(d$X1),X2=c(quantile(d$X2,0.05),median(d$X2))))
#+END_SRC   

#+RESULTS:
#+begin_example
$`X1=low survival, X2=-1.543`
 [1] 0.00000000 0.00000000 0.05263158 0.31578947 0.36842105 0.52631579 0.68421053 0.78947368 0.89473684         NA
[11]         NA

$`X1=medium survival, X2=-1.543`
 [1] 0.00000000 0.07692308 0.07692308 0.15384615 0.30769231 0.38461538 0.38461538 0.46153846 0.53846154 0.76923077
[11] 0.76923077

$`X1=high survival, X2=-1.543`
 [1] 0.0000000 0.0000000 0.0000000 0.0000000 0.1363636 0.1818182 0.1818182 0.1818182 0.2755682 0.2755682 0.3721591

$`X1=low survival, X2= 0.024`
 [1] 0.0000000 0.1379310 0.3103448 0.4137931 0.5517241 0.7586207 0.9310345 0.9655172        NA        NA        NA

$`X1=medium survival, X2= 0.024`
 [1] 0.00000000 0.04761905 0.14285714 0.19047619 0.28571429 0.33333333 0.42857143 0.52380952 0.57142857 0.71428571
[11] 0.76190476

$`X1=high survival, X2= 0.024`
 [1] 0.00000000 0.00000000 0.02564103 0.10256410 0.15535445 0.18174962 0.20814480 0.20814480 0.34989665 0.40659740
[11] 0.49963577
#+end_example

*** plot
#+BEGIN_SRC R :results graphics :file "f3.png" :exports both :session *R* :cache no 
plot(f3,confint=FALSE,atrisk=FALSE,legend.x="bottomleft",legend.cex=0.8,newdata=expand.grid(X1=levels(d$X1),X2=c(quantile(d$X2,0.05),median(d$X2))))
#+END_SRC   

#+RESULTS:
[[file:f3.png]]

* Special cases
** Compare with survfit (survival)

#+BEGIN_SRC R :results graphics :file "compSurvival.png" :exports both :session *R* :cache yes 
library(survival)
data(pbc)
prodlim.0 <- prodlim(Hist(time,status!=0)~1,data=pbc)
survfit.0 <- survfit(Surv(time,status!=0)~1,data=pbc)
plot(survfit.0)
plot(prodlim.0,add=TRUE,col=2,lwd=3)
#+END_SRC   

#+RESULTS[<2017-07-05 06:40:20> 88b5dc5d56176925a04f4e53c885c32de6b2c8f6]:
[[file:compSurvival.png]]

#+BEGIN_SRC R :exports both :results output   :session *R* :cache no 
## There is arounding issue:
library(survival)
testdata <- data.frame(time=c(16.107812,3.657545,1.523978),event=c(0,1,1))
sum0 <- summary(survfit(Surv(time,event)~1,data=testdata),times=sort(testdata$time))
testdata$timeR <- round(testdata$time,1)
sum1 <- summary(survfit(Surv(timeR,event)~1,data=testdata),times=sort(testdata$time))
sum0
sum1
#+END_SRC   

#+RESULTS:
#+begin_example
null device 
          1
null device 
          1
Call: survfit(formula = Surv(time, event) ~ 1, data = testdata)

  time n.risk n.event survival std.err lower 95% CI upper 95% CI
  1.52      3       1    0.667   0.272       0.2995            1
  3.66      2       1    0.333   0.272       0.0673            1
 16.11      1       0    0.333   0.272       0.0673            1
Call: survfit(formula = Surv(timeR, event) ~ 1, data = testdata)

 time n.risk n.event survival std.err lower 95% CI upper 95% CI
 1.52      2       1    0.667   0.272          0.3            1
 3.66      2       0    0.667   0.272          0.3            1
#+end_example

** Bootstrap weights

#+BEGIN_SRC R :results graphics :file "bw.png" :exports both :session *R* :cache yes 
pbc <- pbc[order(pbc$time,-pbc$status),]
set.seed(17)
boot <- sample(1:NROW(pbc),size=NROW(pbc),replace=TRUE)
boot.weights <- table(factor(boot,levels=1:NROW(pbc)))
S1 <- prodlim(Hist(time,status>0)~1,data=pbc,caseweights=boot.weights)
plot(S1,col=1,confint=FALSE,lwd=8)
S2 <- prodlim(Hist(time,status>0)~1,data=pbc[sort(boot),])
plot(S2,add=TRUE,col=2,confint=FALSE,lwd=3)
#+END_SRC   

#+RESULTS[<2017-07-05 06:40:20> c806f2949ef71a98d81e35152f3e38a5e19b26d0]:
[[file:bw.png]]

** Case-weights 
*** Without covariates
#+BEGIN_SRC R :results graphics :file "compSurvey.png" :exports both :session *R* :cache yes 
library(survey)
library(survival)
library(prodlim)
pbc <- pbc[order(pbc$time,-pbc$status),]
## pbc$randprob<-fitted(biasmodel)
## pbc$randprob <- as.numeric(pbc$sex=="m")+0.1
set.seed(17)
pbc$randprob <- abs(rnorm(NROW(pbc)))
dpbc <- svydesign(id=~id, weights=~randprob, strata=NULL, data=pbc)
survey.1<-svykm(Surv(time,status>0)~1, design=dpbc)
plot(survey.1,lwd=8)
prodlim.1 <- prodlim(Hist(time,status>0)~1,data=pbc,caseweights=pbc$randprob)
plot(prodlim.1,add=TRUE,col=2,confint=FALSE)
#+END_SRC   

#+RESULTS[<2017-07-05 06:40:20> 4bca3a798950aadf276e3fe896c036e2e15e4678]:
[[file:compSurvey.png]]

*** With  covariates

#+BEGIN_SRC R  :results output raw drawer  :exports results  :session *R* :cache yes 
d <- data.frame(time=c(1:2,1:2),status=c(1,1,1,1),group=c(1,1,2,2),w=c(0.5,1,8,1))
d$w <- c(1,1,.5,1)
x <- prodlim(Hist(time,status)~ group, data=d, caseweights = d$w)
x1 <- prodlim(Hist(time,status)~ 1, data=d[d$group==1,], caseweights = d[d$group==1,]$w)
x2 <- prodlim(Hist(time,status)~ 1, data=d[d$group==2,], caseweights = d[d$group==2,]$w)
cbind(x$surv, c(x1$surv, x2$surv))
#+END_SRC

#+RESULTS[<2017-07-05 06:40:20> 3955e21d8c912fbc6b1fff8c5ad0334a5d678c3e]:
:RESULTS:
null device 
          1
null device 
          1
          [,1]      [,2]
[1,] 0.5000000 0.5000000
[2,] 0.0000000 0.0000000
[3,] 0.6666667 0.6666667
[4,] 0.0000000 0.0000000
:END:

#+BEGIN_SRC R :results graphics :file "compSurvey.png" :exports both :session *R* :cache yes 
library(survey)
library(survival)
library(prodlim)
set.seed(0815)
dat <- SimSurv(30)
dat$weights <- runif(30) # some nonsensical weights (0,1)
dat$group   <- rbinom(30,1,0.5) # some grouping
pfitw <- prodlim(Hist(time,status)~ group, data=dat, caseweights = dat$weights)
sfitw <- survfit(Surv(time,status)~ group, data=dat, conf.type="plain", weights=dat$weights)
all(round(pfitw$surv,12)==round(sfitw$surv,12)) # FALSE
cbind(round(pfitw$surv,10),round(sfitw$surv,10))
# compare with survey package
design <- svydesign(ids=~1, weights=~weights, data=dat)
svyfit <- svykm(Surv(time,status) ~ group , design=design)
# quartiles of survfit and svykm agree
t(sapply(svyfit, quantile))
quantile(sfitw)$quantile # as for svykm
quantile(pfitw) # different
#+END_SRC

#+RESULTS[<2017-07-05 06:40:20> c64fb64d551b15cf8cd7dc017777e23e6e8cdbb6]:
[[file:compSurvey.png]]

** delayed entry 
*** Without covariates

#+BEGIN_SRC R :results graphics :file "d0.png" :exports results :session *R* :cache yes 
pbc$entry <- round(pbc$time/5)
survfit.delay <- survfit(Surv(entry,time,status!=0)~1,data=pbc)
prodlim.delay <- prodlim(Hist(time,status!=0,entry=entry)~1,data=pbc)
plot(survfit.delay,lwd=8)
plot(prodlim.delay,lwd=4,col=2,add=TRUE,confint=FALSE)
#+END_SRC

#+RESULTS[<2017-07-05 06:40:20> 20028e4875dbbd227e505eba9fb3c71e61e8395c]:
[[file:d0.png]]

*** With covariates

#+BEGIN_SRC R :results graphics :file "compSurvDelayEdema.png" :exports both :session *R* :cache yes 
pbc0 <- pbc
pbc0$entry <- round(pbc0$time/5)
survfit.delay.edema <- survfit(Surv(entry,time,status!=0)~edema,data=pbc0)
## survfit.delay.edema.0.5 <- survfit(Surv(entry,time,status!=0)~1,data=pbc0[pbc0$edema==0.5,])
prodlim.delay.edema <- prodlim(Hist(time,status!=0,entry=entry)~edema,data=pbc0)
## prodlim.delay.edema.0.5 <- prodlim(Hist(time,status!=0,entry=entry)~1,data=pbc0[pbc0$edema==0.5,])
plot(survfit.delay.edema,conf.int=FALSE,col=1:3,lwd=8)
plot(prodlim.delay.edema,add=TRUE,confint=FALSE,col=c("gray88","orange",5),lwd=4)
#+END_SRC    

#+RESULTS[<2017-07-05 06:40:20> 073ae5ec55ec616096d536285e633c983be062c6]:
[[file:compSurvDelayEdema.png]]

** Stacked plot
  
#+BEGIN_SRC R :results graphics  :file "aj.png" :exports both :session *R* :cache no 
library(riskRegression)
data(Melanoma)
aj <- prodlim(Hist(time,Event)~1,data=d)
plot(aj,cause="stacked")
#+END_SRC

#+RESULTS:
[[file:aj.png]]

** Competing risks with delayed entry 
*** Without covariates

#+BEGIN_SRC R :results graphics :file "compETM3.png" :exports both :session *R* :cache yes 
library(etm)
data(abortion)
cif.ab.etm <- etmCIF(Surv(entry, exit, cause != 0) ~ 1,abortion,etype = cause,failcode = 3)
cif.ab.prodlim <- prodlim(Hist(time=exit, event=cause,entry=entry) ~ 1,data=abortion)
plot(cif.ab.etm,lwd=8,col=3)
plot(cif.ab.prodlim,add=TRUE,lwd=4,col=5,cause=3)
#+END_SRC   

#+RESULTS[<2017-07-05 06:40:20> 09a841a2c7a2fce694d188cb5ca62f312f251d60]:
[[file:compETM3.png]]

#+BEGIN_SRC R :results graphics  :file "compETM22.png" :exports both :session *R* :cache no 
library(etm)
data(abortion)
x <- prodlim(Hist(time=exit, event=cause,entry=entry) ~ 1,data=abortion)
x0 <- etmCIF(Surv(entry, exit, cause != 0) ~ 1,abortion,etype = cause)
par(mfrow=c(2,2))
cif.ab.etm <- etmCIF(Surv(entry, exit, cause != 0) ~ 1,abortion,etype = cause,failcode = 3)
cif.ab.prodlim <- prodlim(Hist(time=exit, event=cause,entry=entry) ~ 1,data=abortion)
# cause 3
plot(cif.ab.etm, ci.type = "bars", pos.ci = 24, col = c(1, 2), lty = 1,which.cif=3,lwd=8)
plot(cif.ab.prodlim,add=TRUE,cause=3,confint=TRUE,col=2)
# cause 2
plot(cif.ab.etm, ci.type = "bars", pos.ci = 24, col = c(1, 2), lty = 1,which.cif=2,lwd=8)
plot(cif.ab.prodlim,add=TRUE,cause=2,confint=TRUE,col=2)
# cause 1
plot(cif.ab.etm, ci.type = "bars", pos.ci = 24, col = c(1, 2), lty = 1,which.cif=1,lwd=8)
plot(cif.ab.prodlim,add=TRUE,cause=1,confint=TRUE,col=2)
#+END_SRC

#+RESULTS:
[[file:compETM22.png]]

    
*** With covariates

#+BEGIN_SRC R :results graphics :file "compETMcovariate.png" :exports results :session *R* :cache yes 
par(mfrow=c(1,1))
library(etm)
data(abortion)
cif.ab.etm <- etmCIF(Surv(entry, exit, cause != 0) ~ group,abortion,etype = cause,failcode = 3)
names(cif.ab.etm[[1]])
head(cbind(cif.ab.etm[[1]]$time,cif.ab.etm[[1]]$n.risk))
cif.ab.prodlim <- prodlim(Hist(time=exit, event=cause,entry=entry) ~ group,data=abortion)
plot(cif.ab.etm, ci.type = "bars", pos.ci = 24, col = c(1, 2), lty = 1, curvlab = c("Control", "Exposed"),lwd=8)
plot(cif.ab.prodlim,add=TRUE,cause=3,confint=FALSE,col="yellow")
#+END_SRC

#+RESULTS[<2017-07-05 06:40:21> 1b7349a0142933e135f1c7288731960383730777]:
[[file:compETMcovariate.png]]

#+BEGIN_SRC R  :results output   :exports both  :session *R* :cache no :eval never
library(survival)
library(prodlim)
library(etm)
testdata <- data.frame(entry=c(1,5,2,8,5),exit=c(10,6,4,12,33),event=c(0,1,0,1,0))
cif.test.etm <- etmCIF(Surv(entry, exit, event) ~ 1,data=testdata,etype = event,failcode = 1)
cif.test.survival <- survfit(Surv(entry, exit, event) ~ 1,data=testdata)
cif.test.prodlim <- prodlim(Hist(exit,event,entry=entry)~1,data=testdata)
plot(cif.test.etm, ci.type = "bars", pos.ci = 24, lwd=5)
plot(cif.test.etm, ci.type = "bars", pos.ci = 24, lwd=5)
plot(cif.test.prodlim,add=TRUE,cause=2,col=2,confint=TRUE,type="cuminc")
#+END_SRC


* HEADER :noexport:

#+TITLE: Testing the prodlim package
#+LANGUAGE:  en
#+OPTIONS:   H:3 num:t toc:t \n:nil @:t ::t |:t ^:t -:t f:t *:t <:t
#+OPTIONS:   TeX:t LaTeX:t skip:nil d:t todo:t pri:nil tags:not-in-toc author:nil
#+LaTeX_CLASS: org-article
#+HTML_HEAD: <link rel="stylesheet" type="text/css" href="http://192.38.117.59/~tag/styles/practicals.css" />
#+LaTeX_HEADER:\usepackage{authblk}
#+LaTeX_HEADER:\author{Thomas Alexander Gerds}
#+PROPERTY: session *R*
#+PROPERTY: cache no
#+PROPERTY: tangle yes
